---


- name: Complete cleanup - remove entire project directory
  file:
   path: "{{ project_path }}"
   state: absent
  ignore_errors: yes

- name: Recreate project directory
  file:
   path: "{{ project_path }}"
   state: directory
   owner: "{{ django_user }}"
   group: "{{ django_user }}"
   mode: '0755'


# ========== DJANGO SETUP ==========
- name: Create virtual environment
  command:
    cmd: python3 -m venv venv
    chdir: "{{ project_path }}"
    creates: "{{ project_path }}/venv/bin/python"
  become: yes
  become_user: "{{ django_user }}"

- name: Upgrade pip in virtual environment
  pip:
    virtualenv: "{{ project_path }}/venv"
    name: pip
    state: latest

- name: Install Django and dependencies (without Pillow first)
  pip:
    virtualenv: "{{ project_path }}/venv"
    name:
      - django==4.2.7
      - gunicorn==21.2.0
      - psycopg2-binary==2.9.7
    state: present

- name: Install Pillow with build dependencies
  pip:
    virtualenv: "{{ project_path }}/venv"
    name: 
      - pillow==10.0.0
    state: present
    extra_args: "--no-cache-dir"

- name: Create Django project structure using shell script
  shell: |
    set -e
    cd {{ project_path }}
    {{ project_path }}/venv/bin/django-admin startproject {{ django_project }} .
    {{ project_path }}/venv/bin/python manage.py startapp {{ django_app }}
    echo "Django project and app created successfully"
  args:
    executable: /bin/bash
  become: yes
  become_user: "{{ django_user }}"

- name: Generate Django secret key
  shell:
    cmd: "{{ project_path }}/venv/bin/python -c 'from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())'"
  register: secret_key
  changed_when: false
  become: yes
  become_user: "{{ django_user }}"

- name: Create Django settings with PostgreSQL configuration
  copy:
    content: |
      """
      Django settings for {{ django_project }} project.
      """
      import os
      from pathlib import Path

      BASE_DIR = Path(__file__).resolve().parent.parent

      SECRET_KEY = '{{ secret_key.stdout }}'

      DEBUG = True

      ALLOWED_HOSTS = ['*']

      INSTALLED_APPS = [
          'django.contrib.admin',
          'django.contrib.auth',
          'django.contrib.contenttypes',
          'django.contrib.sessions',
          'django.contrib.messages',
          'django.contrib.staticfiles',
          '{{ django_app }}',
      ]

      MIDDLEWARE = [
          'django.middleware.security.SecurityMiddleware',
          'django.contrib.sessions.middleware.SessionMiddleware',
          'django.middleware.common.CommonMiddleware',
          'django.middleware.csrf.CsrfViewMiddleware',
          'django.contrib.auth.middleware.AuthenticationMiddleware',
          'django.contrib.messages.middleware.MessageMiddleware',
          'django.middleware.clickjacking.XFrameOptionsMiddleware',
      ]

      ROOT_URLCONF = '{{ django_project }}.urls'

      TEMPLATES = [
          {
              'BACKEND': 'django.template.backends.django.DjangoTemplates',
              'DIRS': [],
              'APP_DIRS': True,
              'OPTIONS': {
                  'context_processors': [
                      'django.template.context_processors.debug',
                      'django.template.context_processors.request',
                      'django.contrib.auth.context_processors.auth',
                      'django.contrib.messages.context_processors.messages',
                  ],
              },
          },
      ]

      WSGI_APPLICATION = '{{ django_project }}.wsgi.application'

      DATABASES = {
          'default': {
              'ENGINE': 'django.db.backends.postgresql',
              'NAME': '{{ db_name }}',
              'USER': '{{ db_user }}',
              'PASSWORD': '{{ db_password }}',
              'HOST': 'localhost',
              'PORT': '5432',
          }
      }

      AUTH_PASSWORD_VALIDATORS = [
          {
              'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
          },
          {
              'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
          },
          {
              'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
          },
          {
              'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
          },
      ]

      LANGUAGE_CODE = 'en-us'
      TIME_ZONE = 'UTC'
      USE_I18N = True
      USE_TZ = True

      STATIC_URL = '/static/'
      STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles')

      DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'
    dest: "{{ project_path }}/{{ django_project }}/settings.py"
    owner: "{{ django_user }}"
    group: "{{ django_user }}"
    mode: '0644'

- name: Create simple view
  copy:
    content: |
      from django.http import HttpResponse

      def index(request):
          return HttpResponse("Hello from Django! Your application is working successfully with PostgreSQL!")
    dest: "{{ project_path }}/{{ django_app }}/views.py"
    owner: "{{ django_user }}"
    group: "{{ django_user }}"
    mode: '0644'

- name: Create app URLs
  copy:
    content: |
      from django.urls import path
      from . import views

      urlpatterns = [
          path('', views.index, name='index'),
      ]
    dest: "{{ project_path }}/{{ django_app }}/urls.py"
    owner: "{{ django_user }}"
    group: "{{ django_user }}"
    mode: '0644'

- name: Update project URLs
  copy:
    content: |
      from django.contrib import admin
      from django.urls import path, include

      urlpatterns = [
          path('admin/', admin.site.urls),
          path('', include('{{ django_app }}.urls')),
      ]
    dest: "{{ project_path }}/{{ django_project }}/urls.py"
    owner: "{{ django_user }}"
    group: "{{ django_user }}"
    mode: '0644'

# ========== VERIFICATION AND MIGRATIONS ==========
- name: Verify Django files were created correctly
  shell: "find {{ project_path }} -name '*.py' -type f | head -10"
  register: django_files
  become: yes
  become_user: "{{ django_user }}"

- name: Show Django files
  debug:
    var: django_files.stdout

- name: Check views.py content
  shell: "cat {{ project_path }}/{{ django_app }}/views.py"
  register: views_check
  become: yes
  become_user: "{{ django_user }}"

- name: Display views.py content for verification
  debug:
    msg: "Views.py content: {{ views_check.stdout }}"

- name: Check Python package installation
  shell: "{{ project_path }}/venv/bin/python -c \"import django, gunicorn, psycopg2; print('All packages imported successfully')\""
  register: package_check
  become: yes
  become_user: "{{ django_user }}"
  ignore_errors: yes

- name: Show package check result
  debug:
    var: package_check

- name: Test Django configuration
  shell: "{{ project_path }}/venv/bin/python -c \"import {{ django_project }}.settings; print('Settings imported successfully')\""
  args:
    chdir: "{{ project_path }}"
  register: django_test
  become: yes
  become_user: "{{ django_user }}"
  ignore_errors: yes

    # ========== GUNICORN SETUP ==========
- name: Create Gunicorn config file
  copy:
   content: |
      bind = '127.0.0.1:8000'
      workers = 3
      user = '{{ django_user }}'
      group = '{{ django_user }}'
      pythonpath = '{{ project_path }}'
      chdir = '{{ project_path }}'
      module = '{{ django_project }}.wsgi:application'
   dest: "{{ project_path }}/gunicorn.conf.py"
   owner: "{{ django_user }}"
   group: "{{ django_user }}"
   mode: '0644'

- name: Create Gunicorn systemd service
  copy:
    content: |
      [Unit]
      Description=gunicorn daemon for Django
      After=network.target

      [Service]
      User={{ django_user }}
      Group={{ django_user }}
      WorkingDirectory={{ project_path }}
      ExecStart={{ project_path }}/venv/bin/gunicorn --config {{ project_path }}/gunicorn.conf.py {{ django_project }}.wsgi:application
      ExecReload=/bin/kill -s HUP $MAINPID
      Restart=on-failure

      [Install]
      WantedBy=multi-user.target
    dest: /etc/systemd/system/gunicorn.service
    mode: '0644'

    # ========== SERVICE MANAGEMENT ==========
- name: Reload systemd and start Gunicorn
  systemd:
    name: gunicorn
    state: started
    enabled: yes
    daemon_reload: yes

- name: Ensure Nginx is enabled and started
  systemd:
    name: nginx
    state: restarted
    enabled: yes

